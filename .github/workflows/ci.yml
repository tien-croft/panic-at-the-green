name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GODOT_VERSION: 4.6.0
  EXPORT_NAME: panic-at-the-green

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: ${{ env.GODOT_VERSION }}
        use-dotnet: false

    - name: Verify Godot Installation
      run: godot --version

    - name: Install GUT
      run: |
        mkdir -p addons
        git clone --depth 1 --branch godot_4 https://github.com/bitwes/Gut.git addons/gut

    - name: Run Tests
      run: |
        godot --headless -s addons/gut/gut_cmdln.gd --path $PWD
      timeout-minutes: 5

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: .gut_stats.json

  lint:
    name: Lint GDScript
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install gdtoolkit
      run: |
        pip install gdtoolkit

    - name: Check Formatting
      run: |
        gdformat --check scripts/ tests/ || (echo "Run 'make format' locally to fix"; exit 1)
      continue-on-error: true

    - name: Run Linter
      run: |
        gdlint scripts/ tests/
      continue-on-error: true

  build-web:
    name: Build Web Export
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
    - uses: actions/checkout@v4

    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: ${{ env.GODOT_VERSION }}
        use-dotnet: false

    - name: Install GUT
      run: |
        mkdir -p addons
        git clone --depth 1 --branch godot_4 https://github.com/bitwes/Gut.git addons/gut

    - name: Create Build Directory
      run: mkdir -p build

    - name: Setup Export Templates
      run: |
        mkdir -p ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
        # Note: In production, download templates from https://downloads.tuxfamily.org/godotengine/
        echo "Export templates should be downloaded manually or cached"

    - name: Build Web Export
      run: |
        godot --headless --export-release "Web" ./build/index.html || echo "Build requires export templates"
      continue-on-error: true

    - name: Upload Build Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: web-export
        path: build/
        if-no-files-found: warn
